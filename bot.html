<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHM AI Chatbot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #6e48aa;
            --secondary-color: #9d50bb;
            --accent-color: #4776E6;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
            --success-color: #4cc9f0;
            --user-bubble: #6e48aa;
            --bot-bubble: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .chat-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo i {
            color: var(--primary-color);
            font-size: 20px;
        }

        .header-title h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header-title p {
            font-size: 12px;
            opacity: 0.8;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Chat container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }

        /* Message bubbles */
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message-user {
            align-items: flex-end;
        }

        .message-bot {
            align-items: flex-start;
        }

        .bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 5px;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-bubble {
            background-color: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .bot-bubble {
            background-color: var(--bot-bubble);
            color: white;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 11px;
            color: #777;
            margin: 0 10px;
        }

        /* Input area */
        .input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 15px;
            resize: none;
            max-height: 150px;
            transition: border 0.3s;
        }

        .message-input:focus {
            border-color: var(--primary-color);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer !important;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
            pointer-events: auto !important;
            z-index: 100;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(110, 72, 170, 0.4);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            padding: 10px 15px;
            background-color: var(--bot-bubble);
            color: white;
            border-radius: 18px;
            margin-bottom: 15px;
            align-self: flex-start;
            max-width: 80px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .bubble {
                max-width: 90%;
            }
        }

        /* API Key Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            font-size: 20px;
            color: var(--primary-color);
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #333;
        }

        .api-key-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .api-key-save {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
            transition: transform 0.2s;
        }

        .api-key-save:hover {
            transform: translateY(-2px);
        }

        .toggle-api-btn {
            margin-right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .toggle-api-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-active {
            background-color: #4cc9f0;
        }

        .status-inactive {
            background-color: #f94144;
        }

        .security-notice {
            font-size: 12px;
            color: #f94144;
            margin-top: 10px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="chat-header">
        <div class="logo-container">
            <div class="logo">
                <i class="fas fa-brain"></i>
            </div>
            <div class="header-title">
                <h1>DHM AI Assistant</h1>
                <p>Phi√™n b·∫£n 1.0</p>
            </div>
        </div>
        <div class="header-controls">
            <button class="toggle-api-btn" id="toggleApiBtn">
                <span class="status-indicator status-inactive" id="apiStatusIndicator"></span>
                OpenAI API
            </button>
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                ƒêƒÉng xu·∫•t
            </button>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will appear here -->
            <div class="message message-bot">
                <div class="bubble bot-bubble">
                    Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI c·ªßa H·ªçc vi·ªán DHM. T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay?
                </div>
                <div class="message-time">H√¥m nay, <span id="current-time"></span></div>
            </div>
        </div>

        <div class="input-area">
            <textarea class="message-input" id="messageInput" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." rows="1"></textarea>
            <button class="send-btn" id="sendBtn" disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div class="modal" id="apiKeyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>C√†i ƒë·∫∑t OpenAI API</h2>
                <span class="close-modal" id="closeModal">&times;</span>
            </div>
            <p>Nh·∫≠p OpenAI API key c·ªßa b·∫°n ƒë·ªÉ k·∫øt n·ªëi v·ªõi d·ªãch v·ª• OpenAI:</p>
            <div class="api-type-selection" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px;"><strong>Lo·∫°i API key:</strong></label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="apiKeyType" value="standard" checked> API key th√¥ng th∆∞·ªùng (sk-...)
                </label>
                <label>
                    <input type="radio" name="apiKeyType" value="project"> Project API key (sk-proj-...)
                </label>
            </div>
            <input type="password" id="apiKeyInput" class="api-key-input" placeholder="sk-..." />
            
            <!-- Th√™m ph·∫ßn c·∫•u h√¨nh URL c·ªßa Apps Script -->
            <div style="margin: 15px 0; border-top: 1px solid #eee; padding-top: 15px;">
                <label style="display: block; margin-bottom: 8px;"><strong>URL Google Apps Script (T√πy ch·ªçn):</strong></label>
                <input type="text" id="appsScriptUrlInput" class="api-key-input" placeholder="https://script.google.com/macros/s/..." />
                <p style="font-size: 12px; color: #777; margin-top: 5px;">
                    Nh·∫≠p URL c·ªßa Google Apps Script n·∫øu URL m·∫∑c ƒë·ªãnh kh√¥ng ho·∫°t ƒë·ªông.
                </p>
            </div>
            
            <button id="saveApiKey" class="api-key-save">L∆∞u v√† K√≠ch ho·∫°t</button>
            <div class="security-notice">
                <p><strong>L∆∞u √Ω b·∫£o m·∫≠t:</strong> API key ƒë∆∞·ª£c l∆∞u tr·ªØ c·ª•c b·ªô trong tr√¨nh duy·ªát c·ªßa b·∫°n. 
                Kh√¥ng bao gi·ªù chia s·∫ª API key ho·∫∑c s·ª≠ d·ª•ng ·ª©ng d·ª•ng n√†y tr√™n thi·∫øt b·ªã c√¥ng c·ªông.</p>
            </div>
        </div>
    </div>

    <script>
        // C·∫•u h√¨nh b·∫£o m·∫≠t
        const securityConfig = {
            maxMessageLength: 500,        // Gi·ªõi h·∫°n ƒë·ªô d√†i tin nh·∫Øn
            rateLimitMessages: 5,         // S·ªë tin nh·∫Øn t·ªëi ƒëa trong kho·∫£ng th·ªùi gian
            rateLimitInterval: 10000,     // Kho·∫£ng th·ªùi gian t√≠nh t·∫ßn su·∫•t (ms)
            blockedWords: ['hack', 'ddos', 'exploit', 'injection', 'script', '<script', 'eval(', 'document.cookie'],  // T·ª´ kh√≥a b·ªã c·∫•m
            sessionTimeout: 30 * 60 * 1000, // Timeout phi√™n l√†m vi·ªác (30 ph√∫t)
            maxHistorySize: 50,           // Gi·ªõi h·∫°n l·ªãch s·ª≠ tin nh·∫Øn
            enableAuditLog: true,         // Ghi log ho·∫°t ƒë·ªông
            apiKeyEncryptionKey: 'DHM_SECURE_KEY' // Kh√≥a m√£ h√≥a API key (kh√¥ng an to√†n trong production)
        };

        // Bi·∫øn theo d√µi API OpenAI
        let useOpenAI = false;
        let apiKeySet = false;
        
        // Bi·∫øn theo d√µi t·∫ßn su·∫•t g·ª≠i tin nh·∫Øn
        let messageTimestamps = [];
        let totalMessages = 0;
        let lastActivity = Date.now();
        let chatHistory = [];

        // T·∫°m th·ªùi t·∫Øt ki·ªÉm tra ƒëƒÉng nh·∫≠p v√† thi·∫øt l·∫≠p tr·∫°ng th√°i ƒëƒÉng nh·∫≠p m·∫∑c ƒë·ªãnh
        // if(!sessionStorage.getItem('isLoggedIn')) {
        //     window.location.href = 'index.html';
        // }
        
        // Kh·ªüi t·∫°o phi√™n l√†m vi·ªác an to√†n
        function initSecureSession() {
            // T·∫°o ID phi√™n ng·∫´u nhi√™n n·∫øu ch∆∞a c√≥
            if (!sessionStorage.getItem('sessionId')) {
                const randomId = Math.random().toString(36).substring(2, 15) + 
                                Math.random().toString(36).substring(2, 15);
                sessionStorage.setItem('sessionId', randomId);
            }
            
            // Kh·ªüi t·∫°o th√¥ng tin ng∆∞·ªùi d√πng
            if (!sessionStorage.getItem('user')) {
                sessionStorage.setItem('user', JSON.stringify({
                    id: generateSecureId(),
                    name: 'Ng∆∞·ªùi d√πng', 
                    username: 'user',
                    role: 'user',
                    loginTime: new Date().toISOString()
                }));
            }
            
            sessionStorage.setItem('isLoggedIn', 'true');
            
            // Ghi log ƒëƒÉng nh·∫≠p
            logActivity('SESSION_START', 'Phi√™n l√†m vi·ªác b·∫Øt ƒë·∫ßu');
            
            // Thi·∫øt l·∫≠p ki·ªÉm tra timeout
            setInterval(checkSessionTimeout, 60000); // Ki·ªÉm tra m·ªói ph√∫t
        }
        
        // T·∫°o ID an to√†n
        function generateSecureId() {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }
        
        // Ki·ªÉm tra timeout phi√™n l√†m vi·ªác
        function checkSessionTimeout() {
            const now = Date.now();
            if (now - lastActivity > securityConfig.sessionTimeout) {
                // Session timeout - ƒëƒÉng xu·∫•t
                sessionStorage.removeItem('isLoggedIn');
                logActivity('SESSION_TIMEOUT', 'Phi√™n l√†m vi·ªác h·∫øt h·∫°n do kh√¥ng ho·∫°t ƒë·ªông');
                alert('Phi√™n l√†m vi·ªác ƒë√£ h·∫øt h·∫°n do kh√¥ng ho·∫°t ƒë·ªông. Vui l√≤ng l√†m m·ªõi trang ƒë·ªÉ ti·∫øp t·ª•c.');
            }
        }
        
        // C·∫≠p nh·∫≠t th·ªùi gian ho·∫°t ƒë·ªông
        function updateActivity() {
            lastActivity = Date.now();
        }
        
        // M√£ h√≥a d·ªØ li·ªáu nh·∫°y c·∫£m
        function encryptData(data) {
            // S·ª≠a l·ªói m√£ h√≥a UTF-8 (ti·∫øng Vi·ªát v√† emoji)
            try {
                const jsonString = JSON.stringify(data);
                // Encode chu·ªói UTF-8 th√†nh ƒë·ªãnh d·∫°ng an to√†n cho Base64
                return btoa(encodeURIComponent(jsonString).replace(/%([0-9A-F]{2})/g, 
                    function(match, p1) {
                        return String.fromCharCode('0x' + p1);
                    }
                ));
            } catch (e) {
                console.error('L·ªói m√£ h√≥a d·ªØ li·ªáu:', e);
                logActivity('SECURITY_ERROR', 'L·ªói m√£ h√≥a d·ªØ li·ªáu: ' + e.message);
                // Tr·∫£ v·ªÅ chu·ªói r·ªóng n·∫øu c√≥ l·ªói thay v√¨ l√†m crash ·ª©ng d·ª•ng
                return '';
            }
        }
        
        // Gi·∫£i m√£ d·ªØ li·ªáu
        function decryptData(encryptedData) {
            // S·ª≠a l·ªói gi·∫£i m√£ UTF-8
            try {
                if (!encryptedData) return null;
                
                // Gi·∫£i m√£ Base64 v√† chuy·ªÉn v·ªÅ chu·ªói UTF-8
                const decoded = decodeURIComponent(Array.prototype.map.call(atob(encryptedData), 
                    function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }
                ).join(''));
                
                return JSON.parse(decoded);
            } catch (e) {
                console.error('L·ªói gi·∫£i m√£ d·ªØ li·ªáu:', e);
                logActivity('SECURITY_ERROR', 'L·ªói gi·∫£i m√£ d·ªØ li·ªáu: ' + e.message);
                return null;
            }
        }
        
        // Ghi log ho·∫°t ƒë·ªông
        function logActivity(action, details) {
            if (!securityConfig.enableAuditLog) return;
            
            const user = JSON.parse(sessionStorage.getItem('user') || '{}');
            const logEntry = {
                timestamp: new Date().toISOString(),
                action: action,
                userId: user.id || 'anonymous',
                username: user.username || 'anonymous',
                sessionId: sessionStorage.getItem('sessionId') || 'unknown',
                details: details,
                userAgent: navigator.userAgent
            };
            
            // Trong ·ª©ng d·ª•ng th·ª±c t·∫ø, b·∫°n s·∫Ω g·ª≠i log n√†y ƒë·∫øn server
            console.log('Security Log:', logEntry);
            
            // L∆∞u log v√†o localStorage (ch·ªâ ƒë·ªÉ minh h·ªça)
            const logs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
            logs.push(logEntry);
            localStorage.setItem('auditLogs', JSON.stringify(logs.slice(-100))); // Gi·ªØ 100 log g·∫ßn nh·∫•t
        }
        
        // Ki·ªÉm tra n·ªôi dung tin nh·∫Øn c√≥ an to√†n kh√¥ng
        function isSafeContent(message) {
            // Ki·ªÉm tra t·ª´ kh√≥a b·ªã c·∫•m
            for (const word of securityConfig.blockedWords) {
                if (message.toLowerCase().includes(word.toLowerCase())) {
                    logActivity('SECURITY_WARNING', `Tin nh·∫Øn ch·ª©a t·ª´ kh√≥a b·ªã c·∫•m: ${word}`);
                    return false;
                }
            }
            
            // Ki·ªÉm tra k√≠ch th∆∞·ªõc tin nh·∫Øn
            if (message.length > securityConfig.maxMessageLength) {
                logActivity('SECURITY_WARNING', 'Tin nh·∫Øn v∆∞·ª£t qu√° ƒë·ªô d√†i cho ph√©p');
                return false;
            }
            
            return true;
        }
        
        // X·ª≠ l√Ω t·∫ßn su·∫•t g·ª≠i tin nh·∫Øn (ch·ªëng spam)
        function checkRateLimit() {
            const now = Date.now();
            
            // X√≥a c√°c timestamp c≈© h∆°n kho·∫£ng th·ªùi gian gi·ªõi h·∫°n
            messageTimestamps = messageTimestamps.filter(
                timestamp => (now - timestamp) < securityConfig.rateLimitInterval
            );
            
            // Ki·ªÉm tra s·ªë l∆∞·ª£ng tin nh·∫Øn trong kho·∫£ng th·ªùi gian
            if (messageTimestamps.length >= securityConfig.rateLimitMessages) {
                logActivity('SECURITY_WARNING', 'V∆∞·ª£t qu√° gi·ªõi h·∫°n t·∫ßn su·∫•t g·ª≠i tin nh·∫Øn');
                return false;
            }
            
            // Th√™m timestamp hi·ªán t·∫°i
            messageTimestamps.push(now);
            return true;
        }
        
        // L√†m s·∫°ch d·ªØ li·ªáu ƒë·∫ßu v√†o ƒë·ªÉ ngƒÉn XSS
        function sanitizeInput(input) {
            // M√£ h√≥a c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát HTML
            return input
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // L∆∞u l·ªãch s·ª≠ chat an to√†n
        function saveMessageToHistory(message, sender) {
            const now = new Date();
            const entry = {
                timestamp: now.toISOString(),
                sender: sender,
                message: message
            };
            
            chatHistory.push(entry);
            
            // Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc l·ªãch s·ª≠
            if (chatHistory.length > securityConfig.maxHistorySize) {
                chatHistory = chatHistory.slice(chatHistory.length - securityConfig.maxHistorySize);
            }
            
            // Trong ·ª©ng d·ª•ng th·ª±c t·∫ø, b·∫°n c√≥ th·ªÉ m√£ h√≥a v√† l∆∞u tr·ªØ l·ªãch s·ª≠ chat
            const encryptedHistory = encryptData(chatHistory);
            localStorage.setItem('chatHistory', encryptedHistory);
            
            totalMessages++;
        }

        // Kh·ªüi t·∫°o phi√™n l√†m vi·ªác an to√†n
        initSecureSession();

        // Hi·ªÉn th·ªã th·ªùi gian hi·ªán t·∫°i
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        // DOM Elements
        let chatMessages = document.getElementById('chatMessages');
        let messageInput = document.getElementById('messageInput');
        let sendBtn = document.getElementById('sendBtn');
        let logoutBtn = document.getElementById('logoutBtn');
        let toggleApiBtn = document.getElementById('toggleApiBtn');
        let apiStatusIndicator = document.getElementById('apiStatusIndicator');
        let apiKeyModal = document.getElementById('apiKeyModal');
        let apiKeyInput = document.getElementById('apiKeyInput');
        let saveApiKeyBtn = document.getElementById('saveApiKey');
        let closeModalBtn = document.getElementById('closeModal');

        // H√†m ƒë·ªãnh d·∫°ng tin nh·∫Øn (h·ªó tr·ª£ markdown ƒë∆°n gi·∫£n)
        function formatMessage(message) {
            if (!message) return '';
            
            // Chuy·ªÉn ƒë·ªïi c√°c URL th√†nh li√™n k·∫øt
            message = message.toString().replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
            
            // X·ª≠ l√Ω ƒë·ªãnh d·∫°ng code inline
            message = message.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // X·ª≠ l√Ω c√°c kh·ªëi code
            message = message.replace(/```([\s\S]*?)```/g, function(match, p1) {
                return '<pre><code>' + p1.trim() + '</code></pre>';
            });
            
            // X·ª≠ l√Ω xu·ªëng d√≤ng
            message = message.replace(/\n/g, '<br>');
            
            return message;
        }

        // H√†m th√™m tin nh·∫Øn v√†o chat
        function addToChat(role, message) {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;
            messageDiv.innerHTML = `
                <div class="bubble ${role}-bubble">${formatMessage(message)}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // L∆∞u v√†o l·ªãch s·ª≠
            saveMessageToHistory(message, role);
        }
        
        function addSystemMessage(message) {
            const systemDiv = document.createElement('div');
            systemDiv.className = 'message message-system';
            systemDiv.innerHTML = `
                <div class="bubble bot-bubble" style="background-color: #6c757d;">${message}</div>
            `;
            
            chatMessages.appendChild(systemDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function updateStatusText(status) {
            // Th√™m ho·∫∑c c·∫≠p nh·∫≠t ph·∫ßn t·ª≠ tr·∫°ng th√°i
            let statusElement = document.getElementById('status-text');
            if (!statusElement) {
                statusElement = document.createElement('div');
                statusElement.id = 'status-text';
                statusElement.style.fontSize = '12px';
                statusElement.style.color = '#6c757d';
                statusElement.style.textAlign = 'center';
                statusElement.style.padding = '5px';
                statusElement.style.marginBottom = '5px';
                
                // Ch√®n tr∆∞·ªõc khu v·ª±c nh·∫≠p li·ªáu
                document.querySelector('.input-area').before(statusElement);
            }
            
            statusElement.textContent = status;
        }
        
        function setLoading(isLoading) {
            sendBtn.disabled = isLoading;
            messageInput.disabled = isLoading;
            
            if (isLoading) {
                // Th√™m hi·ªáu ·ª©ng ƒëang t·∫£i
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            } else {
                // Kh√¥i ph·ª•c bi·ªÉu t∆∞·ª£ng g·ª≠i tin nh·∫Øn
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                // Ch·ªâ v√¥ hi·ªáu h√≥a n√∫t g·ª≠i n·∫øu √¥ nh·∫≠p li·ªáu tr·ªëng
                sendBtn.disabled = messageInput.value.trim() === '';
            }
        }

        // Ki·ªÉm tra API key ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t ch∆∞a
        function checkApiKeyStatus() {
            try {
                const encryptedKey = localStorage.getItem('openai_api_key');
                if (encryptedKey) {
                    apiKeySet = true;
                    apiStatusIndicator.classList.remove('status-inactive');
                    apiStatusIndicator.classList.add('status-active');
                    toggleApiBtn.title = 'API key ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t';
                } else {
                    apiKeySet = false;
                    apiStatusIndicator.classList.remove('status-active');
                    apiStatusIndicator.classList.add('status-inactive');
                    toggleApiBtn.title = 'API key ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t';
                }
            } catch (e) {
                console.error('L·ªói ki·ªÉm tra API key:', e);
                apiKeySet = false;
            }
        }

        // M√£ h√≥a API key
        function encryptApiKey(apiKey) {
            try {
                // Ph∆∞∆°ng ph√°p m√£ h√≥a ƒë∆°n gi·∫£n (CH·ªà d√πng cho demo)
                // Trong ·ª©ng d·ª•ng th·ª±c t·∫ø, n√™n s·ª≠ d·ª•ng th∆∞ vi·ªán m√£ h√≥a chuy√™n d·ª•ng
                const salted = apiKey + securityConfig.apiKeyEncryptionKey;
                return encryptData(salted);
            } catch (e) {
                console.error('L·ªói m√£ h√≥a API key:', e);
                return null;
            }
        }

        // Gi·∫£i m√£ API key
        function decryptApiKey() {
            try {
                const encrypted = localStorage.getItem('openai_api_key');
                if (!encrypted) return null;
                
                const decrypted = decryptData(encrypted);
                if (!decrypted) {
                    console.error('Kh√¥ng th·ªÉ gi·∫£i m√£ API key');
                    return null;
                }
                
                // Lo·∫°i b·ªè chu·ªói salt
                const apiKey = decrypted.substring(0, decrypted.length - securityConfig.apiKeyEncryptionKey.length);
                
                // Log ph·∫ßn ƒë·∫ßu v√† cu·ªëi c·ªßa API key ƒë·ªÉ debug
                if (apiKey && apiKey.length > 12) {
                    console.log('API key gi·∫£i m√£:', {
                        masked: apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4),
                        length: apiKey.length,
                        isProjectKey: apiKey.startsWith('sk-proj-'),
                        isStandardKey: apiKey.startsWith('sk-') && !apiKey.startsWith('sk-proj-')
                    });
                } else {
                    console.error('API key gi·∫£i m√£ kh√¥ng h·ª£p l·ªá');
                }
                
                return apiKey;
            } catch (e) {
                console.error('L·ªói gi·∫£i m√£ API key:', e);
                logActivity('SECURITY_ERROR', 'L·ªói gi·∫£i m√£ API key: ' + e.message);
                return null;
            }
        }

        // L∆∞u API key
        function saveApiKey(apiKey) {
            if (!apiKey) {
                alert('Vui l√≤ng nh·∫≠p API key c·ªßa b·∫°n.');
                return false;
            }

            const apiKeyTrimmed = apiKey.trim();
            const isProjectKey = apiKeyTrimmed.startsWith('sk-proj-');
            const isStandardKey = apiKeyTrimmed.startsWith('sk-') && !isProjectKey;

            if (!isProjectKey && !isStandardKey) {
                alert('API key kh√¥ng h·ª£p l·ªá. API key OpenAI ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "sk-".');
                return false;
            }

            try {
                // M√£ h√≥a API key tr∆∞·ªõc khi l∆∞u
                const encrypted = encryptApiKey(apiKeyTrimmed);
                localStorage.setItem('openai_api_key', encrypted);
                
                // L∆∞u lo·∫°i API key
                const apiKeyType = isProjectKey ? 'project' : 'standard';
                localStorage.setItem('openai_api_key_type', apiKeyType);
                
                if (isProjectKey) {
                    logActivity('API_KEY_SAVED', 'ƒê√£ l∆∞u Project API key (b·∫Øt ƒë·∫ßu b·∫±ng sk-proj-) v√†o localStorage');
                    console.log('ƒê√£ l∆∞u Project API key');
                } else {
                    logActivity('API_KEY_SAVED', 'ƒê√£ l∆∞u Standard API key (b·∫Øt ƒë·∫ßu b·∫±ng sk-) v√†o localStorage');
                    console.log('ƒê√£ l∆∞u Standard API key');
                }
                
                document.getElementById('api-key-status').textContent = 'API key ƒë√£ ƒë∆∞·ª£c l∆∞u!';
                toggleApiKeyModal(false);
                return true;
            } catch (error) {
                console.error('L·ªói khi l∆∞u API key:', error);
                alert('C√≥ l·ªói x·∫£y ra khi l∆∞u API key: ' + error.message);
                return false;
            }
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
        function showError(message) {
            // T·∫°o th√¥ng b√°o l·ªói
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message message-bot';
            errorDiv.innerHTML = `
                <div class="bubble bot-bubble" style="background-color: #f44336;">
                    <i class="fas fa-exclamation-circle"></i> ${message}
                </div>
                <div class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
            `;
            
            // Th√™m v√†o khung chat
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Log l·ªói
            console.error(message);
        }
        
        // Hi·ªÉn th·ªã/·∫©n modal API key
        function toggleApiKeyModal(show) {
            apiKeyModal.style.display = show ? 'flex' : 'none';
        }

        // Simple fallback bot response logic (in case API fails)
        function getLocalBotResponse(userMessage) {
            const user = JSON.parse(sessionStorage.getItem('user') || '{}');
            const lowerMsg = userMessage.toLowerCase();
            
            if(lowerMsg.includes('ch√†o') || lowerMsg.includes('hello')) {
                return `Xin ch√†o ${user.name || user.username || ''}! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?`;
            } else if(lowerMsg.includes('kh√≥a h·ªçc') || lowerMsg.includes('ƒë√†o t·∫°o')) {
                return "H·ªçc vi·ªán DHM cung c·∫•p c√°c kh√≥a h·ªçc v·ªÅ: <br>- <strong>AI c∆° b·∫£n</strong> <br>- <strong>Machine Learning</strong> <br>- <strong>Deep Learning</strong> <br>- <strong>X·ª≠ l√Ω ng√¥n ng·ªØ t·ª± nhi√™n</strong> <br>B·∫°n quan t√¢m ƒë·∫øn lƒ©nh v·ª±c n√†o?";
            } else if(lowerMsg.includes('ai') || lowerMsg.includes('tr√≠ tu·ªá nh√¢n t·∫°o')) {
                return "<strong>AI (Tr√≠ tu·ªá nh√¢n t·∫°o)</strong> l√† lƒ©nh v·ª±c nghi√™n c·ª©u v√† ph√°t tri·ªÉn c√°c h·ªá th·ªëng c√≥ kh·∫£ nƒÉng th·ª±c hi·ªán c√°c nhi·ªám v·ª• ƒë√≤i h·ªèi tr√≠ th√¥ng minh c·ªßa con ng∆∞·ªùi nh∆∞ nh·∫≠n d·∫°ng h√¨nh ·∫£nh, x·ª≠ l√Ω ng√¥n ng·ªØ t·ª± nhi√™n, ra quy·∫øt ƒë·ªãnh.";
            } else if(lowerMsg.includes('c·∫£m ∆°n') || lowerMsg.includes('thanks')) {
                return "Kh√¥ng c√≥ g√¨! N·∫øu b·∫°n c√≥ th√™m c√¢u h·ªèi n√†o, t√¥i lu√¥n s·∫µn s√†ng gi√∫p ƒë·ª° üòä";
            } else if(lowerMsg.includes('gi·ªù') || lowerMsg.includes('time')) {
                return `B√¢y gi·ªù l√† ${new Date().toLocaleTimeString()}`;
            } else {
                return "T√¥i l√† m·ªôt AI v√† ƒëang h·ªçc h·ªèi m·ªói ng√†y. C√¢u h·ªèi c·ªßa b·∫°n kh√° th√∫ v·ªã, nh∆∞ng hi·ªán t·∫°i t√¥i ch∆∞a c√≥ ƒë·ªß th√¥ng tin ƒë·ªÉ tr·∫£ l·ªùi ch√≠nh x√°c. B·∫°n c√≥ th·ªÉ h·ªèi v·ªÅ:<br>- <strong>C√°c kh√≥a h·ªçc AI</strong><br>- <strong>C√¥ng ngh·ªá m√°y h·ªçc</strong><br>- <strong>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng h·ªá th·ªëng</strong>";
            }
        }

        // Danh s√°ch c√°c URL d·ª± ph√≤ng cho API
        const apiEndpoints = [
            // URL hi·ªán t·∫°i (c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông)
            'https://script.google.com/macros/s/AKfycbzhy4VezvPGrcQe48f0I0W4vFbQRFLQAebiDczuJ_Cbc8SUxs3xrpamifxGAelIcytS/exec',
            // URL t·ª´ file t.html
            'https://script.google.com/macros/s/AKfycbyBNO7Pb31AyBiuALXrwkRXyQGNrB61pKyVht5cP-nfWnEHz4P3lxUwG0MernH1kz0o/exec'
            // Th√™m c√°c URL d·ª± ph√≤ng kh√°c t·∫°i ƒë√¢y
        ];
        
        // G·ªçi API th√¥ng qua JSONP ƒë·ªÉ v∆∞·ª£t qua CORS
        async function makeApiCall(endpoint, requestData) {
            try {
                // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang k·∫øt n·ªëi
                updateStatusText('ƒêang k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß...');
                
                // S·ª≠ d·ª•ng URL t·ª´ danh s√°ch endpoint
                const scriptUrl = apiEndpoints[0]; // B·∫Øt ƒë·∫ßu v·ªõi URL ƒë·∫ßu ti√™n
                
                // T·∫°o callback ID duy nh·∫•t
                const callbackId = 'callback_' + Date.now();
                
                // T·∫°o promise ƒë·ªÉ ƒë·ª£i response
                return new Promise((resolve, reject) => {
                    // T·∫°o timeout - tƒÉng l√™n 10 gi√¢y ƒë·ªÉ c√≥ th√™m th·ªùi gian k·∫øt n·ªëi
                    const timeoutId = setTimeout(() => {
                        // C·∫≠p nh·∫≠t tr·∫°ng th√°i khi timeout
                        updateStatusText('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. ƒêang s·ª≠ d·ª•ng ph·∫£n h·ªìi n·ªôi b·ªô.');
                        
                        // S·ª≠ d·ª•ng fallback n·∫øu timeout
                        const fallbackResponse = getLocalBotResponse(requestData.prompt);
                        // console.log("Timeout - s·ª≠ d·ª•ng fallback response:", fallbackResponse);
                        
                        // X√≥a callback
                        window[callbackId] = undefined;
                        
                        // X√≥a script n·∫øu c√≤n t·ªìn t·∫°i
                        const scriptElement = document.getElementById('jsonp_script');
                        if (scriptElement) {
                            document.head.removeChild(scriptElement);
                        }
                        
                        resolve({
                            choices: [{
                                message: {
                                    content: fallbackResponse
                                }
                            }]
                        });
                    }, 10000); // TƒÉng th·ªùi gian timeout t·ª´ 5000 l√™n 10000 (10 gi√¢y)
                    
                    // T·∫°o callback cho JSONP
                    window[callbackId] = function(data) {
                        clearTimeout(timeoutId);
                        
                        // C·∫≠p nh·∫≠t tr·∫°ng th√°i khi c√≥ ph·∫£n h·ªìi
                        updateStatusText('K·∫øt n·ªëi th√†nh c√¥ng.');
                        setTimeout(() => updateStatusText(''), 3000); // X√≥a th√¥ng b√°o sau 3 gi√¢y
                        
                        // X√≥a script
                        const scriptElement = document.getElementById('jsonp_script');
                        if (scriptElement) {
                            document.head.removeChild(scriptElement);
                        }
                        
                        // X√≥a callback ƒë·ªÉ tr√°nh memory leak
                        window[callbackId] = undefined;
                        
                        if (data && data.answer) {
                            resolve({
                                choices: [{
                                    message: {
                                        content: data.answer
                                    }
                                }]
                            });
                        } else if (data && data.message) {
                            console.warn("API tr·∫£ v·ªÅ l·ªói:", data.message);
                            updateStatusText('M√°y ch·ªß tr·∫£ v·ªÅ l·ªói: ' + data.message);
                            const fallbackResponse = getLocalBotResponse(requestData.prompt);
                            // console.log("S·ª≠ d·ª•ng fallback response:", fallbackResponse);
                            
                            resolve({
                                choices: [{
                                    message: {
                                        content: fallbackResponse
                                    }
                                }]
                            });
                        } else {
                            console.warn("API kh√¥ng tr·∫£ v·ªÅ d·ªØ li·ªáu h·ª£p l·ªá");
                            updateStatusText('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá t·ª´ m√°y ch·ªß.');
                            const fallbackResponse = getLocalBotResponse(requestData.prompt);
                            // console.log("S·ª≠ d·ª•ng fallback response:", fallbackResponse);
                            
                            resolve({
                                choices: [{
                                    message: {
                                        content: fallbackResponse
                                    }
                                }]
                            });
                        }
                    };
                    
                    // T·∫°o URL v·ªõi tham s·ªë
                    const url = new URL(scriptUrl);
                    url.searchParams.append('question', requestData.prompt);
                    url.searchParams.append('callback', callbackId);
                    url.searchParams.append('timestamp', new Date().getTime());
                    
                    // T·∫°o script element ƒë·ªÉ g·ªçi JSONP
                    const script = document.createElement('script');
                    script.id = 'jsonp_script';
                    script.src = url.toString();
                    
                    // Th√™m x·ª≠ l√Ω l·ªói cho script 
                    script.onerror = function() {
                        console.error("L·ªói k·∫øt n·ªëi API, ƒëang th·ª≠ URL d·ª± ph√≤ng");
                        
                        // N·∫øu c√≤n URL d·ª± ph√≤ng v√† ƒë√¢y kh√¥ng ph·∫£i URL cu·ªëi c√πng, th·ª≠ URL ti·∫øp theo
                        const currentIndex = apiEndpoints.indexOf(scriptUrl);
                        if (currentIndex >= 0 && currentIndex < apiEndpoints.length - 1) {
                            // X√≥a script hi·ªán t·∫°i
                            document.head.removeChild(script);
                            
                            // Th·ª≠ v·ªõi URL ti·∫øp theo
                            // console.log("ƒêang th·ª≠ v·ªõi URL d·ª± ph√≤ng:", apiEndpoints[currentIndex + 1]);
                            updateStatusText('ƒêang th·ª≠ k·∫øt n·ªëi v·ªõi m√°y ch·ªß d·ª± ph√≤ng...');
                            
                            // T·∫°o script m·ªõi v·ªõi URL ti·∫øp theo
                            const newScript = document.createElement('script');
                            newScript.id = 'jsonp_script';
                            const newUrl = new URL(apiEndpoints[currentIndex + 1]);
                            newUrl.searchParams.append('question', requestData.prompt);
                            newUrl.searchParams.append('callback', callbackId);
                            newUrl.searchParams.append('timestamp', new Date().getTime());
                            newScript.src = newUrl.toString();
                            document.head.appendChild(newScript);
                            
                            // Kh√¥ng trigger timeout l·∫°i, v·∫´n s·ª≠ d·ª•ng timeout ban ƒë·∫ßu
                        } else {
                            // ƒê√£ th·ª≠ t·∫•t c·∫£ c√°c URL, s·ª≠ d·ª•ng fallback
                            clearTimeout(timeoutId); // X√≥a timeout hi·ªán t·∫°i
                            
                            updateStatusText('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn b·∫•t k·ª≥ m√°y ch·ªß n√†o. ƒêang s·ª≠ d·ª•ng ph·∫£n h·ªìi n·ªôi b·ªô.');
                            
                            // S·ª≠ d·ª•ng fallback response
                            const fallbackResponse = getLocalBotResponse(requestData.prompt);
                            // console.log("T·∫•t c·∫£ URL ƒë·ªÅu th·∫•t b·∫°i - s·ª≠ d·ª•ng fallback response:", fallbackResponse);
                            
                            // X·ª≠ l√Ω nh∆∞ timeout
                            window[callbackId] = undefined;
                            resolve({
                                choices: [{
                                    message: {
                                        content: fallbackResponse
                                    }
                                }]
                            });
                        }
                    };
                    
                    document.head.appendChild(script);
                });
            } catch (error) {
                console.error('L·ªói g·ªçi API:', error);
                updateStatusText('L·ªói khi k·∫øt n·ªëi: ' + error.message);
                
                // S·ª≠ d·ª•ng fallback response khi API fails
                const fallbackResponse = getLocalBotResponse(requestData.prompt);
                // console.log("S·ª≠ d·ª•ng fallback response:", fallbackResponse);
                
                return {
                    choices: [{
                        message: {
                            content: fallbackResponse
                        }
                    }]
                };
            }
        }

        // H√†m x·ª≠ l√Ω vi·ªác g·ª≠i tin nh·∫Øn
        async function handleSendMessage() {
            try {
                const userInput = messageInput.value.trim();
                
                if (!userInput) {
                    return; // Kh√¥ng l√†m g√¨ n·∫øu tin nh·∫Øn tr·ªëng
                }

                // Hi·ªÉn th·ªã th√¥ng b√°o ng∆∞·ªùi d√πng
                addToChat('user', userInput);
                
                // X√≥a input sau khi g·ª≠i
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // Disable n√∫t g·ª≠i v√† hi·ªÉn th·ªã loading
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                // G·ªçi API ƒë·ªÉ l·∫•y c√¢u tr·∫£ l·ªùi
                const response = await makeApiCall('chat', { prompt: userInput });
                
                // Hi·ªÉn th·ªã c√¢u tr·∫£ l·ªùi t·ª´ bot
                if (response && response.choices && response.choices[0]) {
                    addToChat('bot', response.choices[0].message.content);
                } else {
                    addToChat('bot', 'Xin l·ªói, t√¥i kh√¥ng th·ªÉ x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n l√∫c n√†y.');
                }
                
            } catch (error) {
                console.error("L·ªói khi g·ª≠i tin nh·∫Øn:", error);
                addToChat('bot', 'ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω tin nh·∫Øn c·ªßa b·∫°n.');
            } finally {
                // Restore n√∫t g·ª≠i
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                sendBtn.disabled = messageInput.value.trim() === '';
            }
        }

        // ƒê·∫£m b·∫£o c√°c DOM elements ƒë∆∞·ª£c kh·ªüi t·∫°o ƒë√∫ng
        document.addEventListener('DOMContentLoaded', function() {
            // Ki·ªÉm tra xem ƒë√£ l·∫•y ƒë∆∞·ª£c c√°c DOM elements ch∆∞a
            if (!chatMessages) chatMessages = document.getElementById('chatMessages');
            if (!messageInput) messageInput = document.getElementById('messageInput');
            if (!sendBtn) sendBtn = document.getElementById('sendBtn');
            
            // console.log("DOM Elements:", {chatMessages, messageInput, sendBtn});
            
            if (messageInput && sendBtn) {
                // ƒê·∫£m b·∫£o n√∫t ƒë∆∞·ª£c enable khi c√≥ text
                messageInput.addEventListener('input', function() {
                    sendBtn.disabled = this.value.trim() === '';
                    
                    // Auto-resize textarea
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
                
                // Th√™m s·ª± ki·ªán click cho n√∫t g·ª≠i
                sendBtn.addEventListener('click', function() {
                    if (messageInput.value.trim() !== '') {
                        if (typeof handleSendMessage === 'function') {
                            handleSendMessage();
                        } else {
                            console.error("handleSendMessage kh√¥ng ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a");
                            alert("L·ªói: Ch·ª©c nƒÉng g·ª≠i tin nh·∫Øn ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t");
                        }
                    }
                });
                
                // Th√™m s·ª± ki·ªán Enter ƒë·ªÉ g·ª≠i tin nh·∫Øn
                messageInput.addEventListener('keydown', function(e) {
                    if(e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if(messageInput.value.trim() !== '') {
                            if (typeof handleSendMessage === 'function') {
                                handleSendMessage();
                            }
                        }
                    }
                });
                
                // Enable n√∫t g·ª≠i n·∫øu c√≥ text
                if (messageInput.value.trim() !== '') {
                    sendBtn.disabled = false;
                }
            } else {
                console.error("Kh√¥ng t√¨m th·∫•y c√°c DOM elements c·∫ßn thi·∫øt");
            }
        });

        saveApiKeyBtn.addEventListener('click', function() {
            const apiKey = apiKeyInput.value;
            const apiKeyType = document.querySelector('input[name="apiKeyType"]:checked').value;
            
            if (saveApiKey(apiKey, apiKeyType)) {
                apiKeySet = true;
                apiStatusIndicator.classList.remove('status-inactive');
                apiStatusIndicator.classList.add('status-active');
                toggleApiKeyModal(false);
                
                // L∆∞u URL Apps Script n·∫øu ƒë√£ nh·∫≠p
                const customUrl = document.getElementById('appsScriptUrlInput').value.trim();
                if (customUrl && customUrl.startsWith('https://script.google.com/macros/s/')) {
                    saveCustomScriptUrl(customUrl);
                }
            }
        });

        // L∆∞u URL Google Apps Script t√πy ch·ªânh
        function saveCustomScriptUrl(url) {
            try {
                if (!url) return false;
                
                // Ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa URL
                if (!url.startsWith('https://script.google.com/macros/s/')) {
                    alert('URL Google Apps Script kh√¥ng h·ª£p l·ªá. URL ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "https://script.google.com/macros/s/"');
                    return false;
                }
                
                // L∆∞u URL v√†o localStorage
                localStorage.setItem('custom_script_url', url);
                // console.log('ƒê√£ l∆∞u URL Apps Script t√πy ch·ªânh:', url);
                
                // C·∫≠p nh·∫≠t danh s√°ch URL
                loadCustomScriptUrl();
                
                return true;
            } catch (error) {
                console.error('L·ªói khi l∆∞u URL t√πy ch·ªânh:', error);
                return false;
            }
        }
        
        // T·∫£i URL t√πy ch·ªânh v√† th√™m v√†o danh s√°ch endpoints
        function loadCustomScriptUrl() {
            try {
                const customUrl = localStorage.getItem('custom_script_url');
                if (customUrl) {
                    // console.log('ƒê√£ t√¨m th·∫•y URL t√πy ch·ªânh:', customUrl);
                    
                    // ƒê·∫∑t URL t√πy ch·ªânh l√™n ƒë·∫ßu danh s√°ch ƒë·ªÉ ∆∞u ti√™n s·ª≠ d·ª•ng
                    if (!apiEndpoints.includes(customUrl)) {
                        apiEndpoints.unshift(customUrl);
                        // console.log('Danh s√°ch URL ƒë√£ c·∫≠p nh·∫≠t:', apiEndpoints);
                    }
                    
                    // Hi·ªÉn th·ªã URL t√πy ch·ªânh trong form
                    const urlInput = document.getElementById('appsScriptUrlInput');
                    if (urlInput) {
                        urlInput.value = customUrl;
                    }
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error('L·ªói khi t·∫£i URL t√πy ch·ªânh:', error);
                return false;
            }
        }
        
        // T·∫£i URL t√πy ch·ªânh khi trang web kh·ªüi ƒë·ªông
        loadCustomScriptUrl();
    </script>
</body>
</html>