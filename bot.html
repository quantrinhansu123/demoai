<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHM AI Chatbot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #6e48aa;
            --secondary-color: #9d50bb;
            --accent-color: #4776E6;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
            --success-color: #4cc9f0;
            --user-bubble: #6e48aa;
            --bot-bubble: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .chat-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo i {
            color: var(--primary-color);
            font-size: 20px;
        }

        .header-title h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header-title p {
            font-size: 12px;
            opacity: 0.8;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Chat container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }

        /* Message bubbles */
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message-user {
            align-items: flex-end;
        }

        .message-bot {
            align-items: flex-start;
        }

        .bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 5px;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-bubble {
            background-color: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .bot-bubble {
            background-color: var(--bot-bubble);
            color: white;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 11px;
            color: #777;
            margin: 0 10px;
        }

        /* Input area */
        .input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 15px;
            resize: none;
            max-height: 150px;
            transition: border 0.3s;
        }

        .message-input:focus {
            border-color: var(--primary-color);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer !important;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
            pointer-events: auto !important;
            z-index: 100;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(110, 72, 170, 0.4);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            padding: 10px 15px;
            background-color: var(--bot-bubble);
            color: white;
            border-radius: 18px;
            margin-bottom: 15px;
            align-self: flex-start;
            max-width: 80px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .bubble {
                max-width: 90%;
            }
        }

        /* API Key Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            font-size: 20px;
            color: var(--primary-color);
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #333;
        }

        .api-key-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .api-key-save {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
            transition: transform 0.2s;
        }

        .api-key-save:hover {
            transform: translateY(-2px);
        }

        .toggle-api-btn {
            margin-right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .toggle-api-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-active {
            background-color: #4cc9f0;
        }

        .status-inactive {
            background-color: #f94144;
        }

        .security-notice {
            font-size: 12px;
            color: #f94144;
            margin-top: 10px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="chat-header">
        <div class="logo-container">
            <div class="logo">
                <i class="fas fa-brain"></i>
            </div>
            <div class="header-title">
                <h1>DHM AI Assistant</h1>
                <p>Phiên bản 1.0</p>
            </div>
        </div>
        <div class="header-controls">
            <button class="toggle-api-btn" id="toggleApiBtn">
                <span class="status-indicator status-inactive" id="apiStatusIndicator"></span>
                OpenAI API
            </button>
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                Đăng xuất
            </button>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will appear here -->
            <div class="message message-bot">
                <div class="bubble bot-bubble">
                    Xin chào! Tôi là trợ lý AI của Học viện DHM. Tôi có thể giúp gì cho bạn hôm nay?
                </div>
                <div class="message-time">Hôm nay, <span id="current-time"></span></div>
            </div>
        </div>

        <div class="input-area">
            <textarea class="message-input" id="messageInput" placeholder="Nhập câu hỏi của bạn..." rows="1"></textarea>
            <button class="send-btn" id="sendBtn" disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div class="modal" id="apiKeyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cài đặt OpenAI API</h2>
                <span class="close-modal" id="closeModal">&times;</span>
            </div>
            <p>Nhập OpenAI API key của bạn để kết nối với dịch vụ OpenAI:</p>
            <div class="api-type-selection" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px;"><strong>Loại API key:</strong></label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="apiKeyType" value="standard" checked> API key thông thường (sk-...)
                </label>
                <label>
                    <input type="radio" name="apiKeyType" value="project"> Project API key (sk-proj-...)
                </label>
            </div>
            <input type="password" id="apiKeyInput" class="api-key-input" placeholder="sk-..." />
            
            <!-- Thêm phần cấu hình URL của Apps Script -->
            <div style="margin: 15px 0; border-top: 1px solid #eee; padding-top: 15px;">
                <label style="display: block; margin-bottom: 8px;"><strong>URL Google Apps Script (Tùy chọn):</strong></label>
                <input type="text" id="appsScriptUrlInput" class="api-key-input" placeholder="https://script.google.com/macros/s/..." />
                <p style="font-size: 12px; color: #777; margin-top: 5px;">
                    Nhập URL của Google Apps Script nếu URL mặc định không hoạt động.
                </p>
            </div>
            
            <button id="saveApiKey" class="api-key-save">Lưu và Kích hoạt</button>
            <div class="security-notice">
                <p><strong>Lưu ý bảo mật:</strong> API key được lưu trữ cục bộ trong trình duyệt của bạn. 
                Không bao giờ chia sẻ API key hoặc sử dụng ứng dụng này trên thiết bị công cộng.</p>
            </div>
        </div>
    </div>

    <script>
        // Cấu hình bảo mật
        const securityConfig = {
            maxMessageLength: 500,        // Giới hạn độ dài tin nhắn
            rateLimitMessages: 5,         // Số tin nhắn tối đa trong khoảng thời gian
            rateLimitInterval: 10000,     // Khoảng thời gian tính tần suất (ms)
            blockedWords: ['hack', 'ddos', 'exploit', 'injection', 'script', '<script', 'eval(', 'document.cookie'],  // Từ khóa bị cấm
            sessionTimeout: 30 * 60 * 1000, // Timeout phiên làm việc (30 phút)
            maxHistorySize: 50,           // Giới hạn lịch sử tin nhắn
            enableAuditLog: true,         // Ghi log hoạt động
            apiKeyEncryptionKey: 'DHM_SECURE_KEY' // Khóa mã hóa API key (không an toàn trong production)
        };

        // Biến theo dõi API OpenAI
        let useOpenAI = false;
        let apiKeySet = false;
        
        // Biến theo dõi tần suất gửi tin nhắn
        let messageTimestamps = [];
        let totalMessages = 0;
        let lastActivity = Date.now();
        let chatHistory = [];

        // Tạm thời tắt kiểm tra đăng nhập và thiết lập trạng thái đăng nhập mặc định
        // if(!sessionStorage.getItem('isLoggedIn')) {
        //     window.location.href = 'index.html';
        // }
        
        // Khởi tạo phiên làm việc an toàn
        function initSecureSession() {
            // Tạo ID phiên ngẫu nhiên nếu chưa có
            if (!sessionStorage.getItem('sessionId')) {
                const randomId = Math.random().toString(36).substring(2, 15) + 
                                Math.random().toString(36).substring(2, 15);
                sessionStorage.setItem('sessionId', randomId);
            }
            
            // Khởi tạo thông tin người dùng
            if (!sessionStorage.getItem('user')) {
                sessionStorage.setItem('user', JSON.stringify({
                    id: generateSecureId(),
                    name: 'Người dùng', 
                    username: 'user',
                    role: 'user',
                    loginTime: new Date().toISOString()
                }));
            }
            
            sessionStorage.setItem('isLoggedIn', 'true');
            
            // Ghi log đăng nhập
            logActivity('SESSION_START', 'Phiên làm việc bắt đầu');
            
            // Thiết lập kiểm tra timeout
            setInterval(checkSessionTimeout, 60000); // Kiểm tra mỗi phút
        }
        
        // Tạo ID an toàn
        function generateSecureId() {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }
        
        // Kiểm tra timeout phiên làm việc
        function checkSessionTimeout() {
            const now = Date.now();
            if (now - lastActivity > securityConfig.sessionTimeout) {
                // Session timeout - đăng xuất
                sessionStorage.removeItem('isLoggedIn');
                logActivity('SESSION_TIMEOUT', 'Phiên làm việc hết hạn do không hoạt động');
                alert('Phiên làm việc đã hết hạn do không hoạt động. Vui lòng làm mới trang để tiếp tục.');
            }
        }
        
        // Cập nhật thời gian hoạt động
        function updateActivity() {
            lastActivity = Date.now();
        }
        
        // Mã hóa dữ liệu nhạy cảm
        function encryptData(data) {
            // Sửa lỗi mã hóa UTF-8 (tiếng Việt và emoji)
            try {
                const jsonString = JSON.stringify(data);
                // Encode chuỗi UTF-8 thành định dạng an toàn cho Base64
                return btoa(encodeURIComponent(jsonString).replace(/%([0-9A-F]{2})/g, 
                    function(match, p1) {
                        return String.fromCharCode('0x' + p1);
                    }
                ));
            } catch (e) {
                console.error('Lỗi mã hóa dữ liệu:', e);
                logActivity('SECURITY_ERROR', 'Lỗi mã hóa dữ liệu: ' + e.message);
                // Trả về chuỗi rỗng nếu có lỗi thay vì làm crash ứng dụng
                return '';
            }
        }
        
        // Giải mã dữ liệu
        function decryptData(encryptedData) {
            // Sửa lỗi giải mã UTF-8
            try {
                if (!encryptedData) return null;
                
                // Giải mã Base64 và chuyển về chuỗi UTF-8
                const decoded = decodeURIComponent(Array.prototype.map.call(atob(encryptedData), 
                    function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }
                ).join(''));
                
                return JSON.parse(decoded);
            } catch (e) {
                console.error('Lỗi giải mã dữ liệu:', e);
                logActivity('SECURITY_ERROR', 'Lỗi giải mã dữ liệu: ' + e.message);
                return null;
            }
        }
        
        // Ghi log hoạt động
        function logActivity(action, details) {
            if (!securityConfig.enableAuditLog) return;
            
            const user = JSON.parse(sessionStorage.getItem('user') || '{}');
            const logEntry = {
                timestamp: new Date().toISOString(),
                action: action,
                userId: user.id || 'anonymous',
                username: user.username || 'anonymous',
                sessionId: sessionStorage.getItem('sessionId') || 'unknown',
                details: details,
                userAgent: navigator.userAgent
            };
            
            // Trong ứng dụng thực tế, bạn sẽ gửi log này đến server
            console.log('Security Log:', logEntry);
            
            // Lưu log vào localStorage (chỉ để minh họa)
            const logs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
            logs.push(logEntry);
            localStorage.setItem('auditLogs', JSON.stringify(logs.slice(-100))); // Giữ 100 log gần nhất
        }
        
        // Kiểm tra nội dung tin nhắn có an toàn không
        function isSafeContent(message) {
            // Kiểm tra từ khóa bị cấm
            for (const word of securityConfig.blockedWords) {
                if (message.toLowerCase().includes(word.toLowerCase())) {
                    logActivity('SECURITY_WARNING', `Tin nhắn chứa từ khóa bị cấm: ${word}`);
                    return false;
                }
            }
            
            // Kiểm tra kích thước tin nhắn
            if (message.length > securityConfig.maxMessageLength) {
                logActivity('SECURITY_WARNING', 'Tin nhắn vượt quá độ dài cho phép');
                return false;
            }
            
            return true;
        }
        
        // Xử lý tần suất gửi tin nhắn (chống spam)
        function checkRateLimit() {
            const now = Date.now();
            
            // Xóa các timestamp cũ hơn khoảng thời gian giới hạn
            messageTimestamps = messageTimestamps.filter(
                timestamp => (now - timestamp) < securityConfig.rateLimitInterval
            );
            
            // Kiểm tra số lượng tin nhắn trong khoảng thời gian
            if (messageTimestamps.length >= securityConfig.rateLimitMessages) {
                logActivity('SECURITY_WARNING', 'Vượt quá giới hạn tần suất gửi tin nhắn');
                return false;
            }
            
            // Thêm timestamp hiện tại
            messageTimestamps.push(now);
            return true;
        }
        
        // Làm sạch dữ liệu đầu vào để ngăn XSS
        function sanitizeInput(input) {
            // Mã hóa các ký tự đặc biệt HTML
            return input
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Lưu lịch sử chat an toàn
        function saveMessageToHistory(message, sender) {
            const now = new Date();
            const entry = {
                timestamp: now.toISOString(),
                sender: sender,
                message: message
            };
            
            chatHistory.push(entry);
            
            // Giới hạn kích thước lịch sử
            if (chatHistory.length > securityConfig.maxHistorySize) {
                chatHistory = chatHistory.slice(chatHistory.length - securityConfig.maxHistorySize);
            }
            
            // Trong ứng dụng thực tế, bạn có thể mã hóa và lưu trữ lịch sử chat
            const encryptedHistory = encryptData(chatHistory);
            localStorage.setItem('chatHistory', encryptedHistory);
            
            totalMessages++;
        }

        // Khởi tạo phiên làm việc an toàn
        initSecureSession();

        // Hiển thị thời gian hiện tại
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        // DOM Elements
        let chatMessages = document.getElementById('chatMessages');
        let messageInput = document.getElementById('messageInput');
        let sendBtn = document.getElementById('sendBtn');
        let logoutBtn = document.getElementById('logoutBtn');
        let toggleApiBtn = document.getElementById('toggleApiBtn');
        let apiStatusIndicator = document.getElementById('apiStatusIndicator');
        let apiKeyModal = document.getElementById('apiKeyModal');
        let apiKeyInput = document.getElementById('apiKeyInput');
        let saveApiKeyBtn = document.getElementById('saveApiKey');
        let closeModalBtn = document.getElementById('closeModal');

        // Hàm định dạng tin nhắn (hỗ trợ markdown đơn giản)
        function formatMessage(message) {
            if (!message) return '';
            
            // Chuyển đổi các URL thành liên kết
            message = message.toString().replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
            
            // Xử lý định dạng code inline
            message = message.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Xử lý các khối code
            message = message.replace(/```([\s\S]*?)```/g, function(match, p1) {
                return '<pre><code>' + p1.trim() + '</code></pre>';
            });
            
            // Xử lý xuống dòng
            message = message.replace(/\n/g, '<br>');
            
            return message;
        }

        // Hàm thêm tin nhắn vào chat
        function addToChat(role, message) {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;
            messageDiv.innerHTML = `
                <div class="bubble ${role}-bubble">${formatMessage(message)}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Lưu vào lịch sử
            saveMessageToHistory(message, role);
        }
        
        function addSystemMessage(message) {
            const systemDiv = document.createElement('div');
            systemDiv.className = 'message message-system';
            systemDiv.innerHTML = `
                <div class="bubble bot-bubble" style="background-color: #6c757d;">${message}</div>
            `;
            
            chatMessages.appendChild(systemDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function updateStatusText(status) {
            // Thêm hoặc cập nhật phần tử trạng thái
            let statusElement = document.getElementById('status-text');
            if (!statusElement) {
                statusElement = document.createElement('div');
                statusElement.id = 'status-text';
                statusElement.style.fontSize = '12px';
                statusElement.style.color = '#6c757d';
                statusElement.style.textAlign = 'center';
                statusElement.style.padding = '5px';
                statusElement.style.marginBottom = '5px';
                
                // Chèn trước khu vực nhập liệu
                document.querySelector('.input-area').before(statusElement);
            }
            
            statusElement.textContent = status;
        }
        
        function setLoading(isLoading) {
            sendBtn.disabled = isLoading;
            messageInput.disabled = isLoading;
            
            if (isLoading) {
                // Thêm hiệu ứng đang tải
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            } else {
                // Khôi phục biểu tượng gửi tin nhắn
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                // Chỉ vô hiệu hóa nút gửi nếu ô nhập liệu trống
                sendBtn.disabled = messageInput.value.trim() === '';
            }
        }

        // Kiểm tra API key đã được cài đặt chưa
        function checkApiKeyStatus() {
            try {
                const encryptedKey = localStorage.getItem('openai_api_key');
                if (encryptedKey) {
                    apiKeySet = true;
                    apiStatusIndicator.classList.remove('status-inactive');
                    apiStatusIndicator.classList.add('status-active');
                    toggleApiBtn.title = 'API key đã được cài đặt';
                } else {
                    apiKeySet = false;
                    apiStatusIndicator.classList.remove('status-active');
                    apiStatusIndicator.classList.add('status-inactive');
                    toggleApiBtn.title = 'API key chưa được cài đặt';
                }
            } catch (e) {
                console.error('Lỗi kiểm tra API key:', e);
                apiKeySet = false;
            }
        }

        // Mã hóa API key
        function encryptApiKey(apiKey) {
            try {
                // Phương pháp mã hóa đơn giản (CHỈ dùng cho demo)
                // Trong ứng dụng thực tế, nên sử dụng thư viện mã hóa chuyên dụng
                const salted = apiKey + securityConfig.apiKeyEncryptionKey;
                return encryptData(salted);
            } catch (e) {
                console.error('Lỗi mã hóa API key:', e);
                return null;
            }
        }

        // Giải mã API key
        function decryptApiKey() {
            try {
                const encrypted = localStorage.getItem('openai_api_key');
                if (!encrypted) return null;
                
                const decrypted = decryptData(encrypted);
                if (!decrypted) {
                    console.error('Không thể giải mã API key');
                    return null;
                }
                
                // Loại bỏ chuỗi salt
                const apiKey = decrypted.substring(0, decrypted.length - securityConfig.apiKeyEncryptionKey.length);
                
                // Log phần đầu và cuối của API key để debug
                if (apiKey && apiKey.length > 12) {
                    console.log('API key giải mã:', {
                        masked: apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4),
                        length: apiKey.length,
                        isProjectKey: apiKey.startsWith('sk-proj-'),
                        isStandardKey: apiKey.startsWith('sk-') && !apiKey.startsWith('sk-proj-')
                    });
                } else {
                    console.error('API key giải mã không hợp lệ');
                }
                
                return apiKey;
            } catch (e) {
                console.error('Lỗi giải mã API key:', e);
                logActivity('SECURITY_ERROR', 'Lỗi giải mã API key: ' + e.message);
                return null;
            }
        }

        // Lưu API key
        function saveApiKey(apiKey) {
            if (!apiKey) {
                alert('Vui lòng nhập API key của bạn.');
                return false;
            }

            const apiKeyTrimmed = apiKey.trim();
            const isProjectKey = apiKeyTrimmed.startsWith('sk-proj-');
            const isStandardKey = apiKeyTrimmed.startsWith('sk-') && !isProjectKey;

            if (!isProjectKey && !isStandardKey) {
                alert('API key không hợp lệ. API key OpenAI phải bắt đầu bằng "sk-".');
                return false;
            }

            try {
                // Mã hóa API key trước khi lưu
                const encrypted = encryptApiKey(apiKeyTrimmed);
                localStorage.setItem('openai_api_key', encrypted);
                
                // Lưu loại API key
                const apiKeyType = isProjectKey ? 'project' : 'standard';
                localStorage.setItem('openai_api_key_type', apiKeyType);
                
                if (isProjectKey) {
                    logActivity('API_KEY_SAVED', 'Đã lưu Project API key (bắt đầu bằng sk-proj-) vào localStorage');
                    console.log('Đã lưu Project API key');
                } else {
                    logActivity('API_KEY_SAVED', 'Đã lưu Standard API key (bắt đầu bằng sk-) vào localStorage');
                    console.log('Đã lưu Standard API key');
                }
                
                document.getElementById('api-key-status').textContent = 'API key đã được lưu!';
                toggleApiKeyModal(false);
                return true;
            } catch (error) {
                console.error('Lỗi khi lưu API key:', error);
                alert('Có lỗi xảy ra khi lưu API key: ' + error.message);
                return false;
            }
        }

        // Hiển thị thông báo lỗi
        function showError(message) {
            // Tạo thông báo lỗi
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message message-bot';
            errorDiv.innerHTML = `
                <div class="bubble bot-bubble" style="background-color: #f44336;">
                    <i class="fas fa-exclamation-circle"></i> ${message}
                </div>
                <div class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
            `;
            
            // Thêm vào khung chat
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Log lỗi
            console.error(message);
        }
        
        // Hiển thị/ẩn modal API key
        function toggleApiKeyModal(show) {
            apiKeyModal.style.display = show ? 'flex' : 'none';
        }

        // Simple fallback bot response logic (in case API fails)
        function getLocalBotResponse(userMessage) {
            const user = JSON.parse(sessionStorage.getItem('user') || '{}');
            const lowerMsg = userMessage.toLowerCase();
            
            if(lowerMsg.includes('chào') || lowerMsg.includes('hello')) {
                return `Xin chào ${user.name || user.username || ''}! Tôi có thể giúp gì cho bạn?`;
            } else if(lowerMsg.includes('khóa học') || lowerMsg.includes('đào tạo')) {
                return "Học viện DHM cung cấp các khóa học về: <br>- <strong>AI cơ bản</strong> <br>- <strong>Machine Learning</strong> <br>- <strong>Deep Learning</strong> <br>- <strong>Xử lý ngôn ngữ tự nhiên</strong> <br>Bạn quan tâm đến lĩnh vực nào?";
            } else if(lowerMsg.includes('ai') || lowerMsg.includes('trí tuệ nhân tạo')) {
                return "<strong>AI (Trí tuệ nhân tạo)</strong> là lĩnh vực nghiên cứu và phát triển các hệ thống có khả năng thực hiện các nhiệm vụ đòi hỏi trí thông minh của con người như nhận dạng hình ảnh, xử lý ngôn ngữ tự nhiên, ra quyết định.";
            } else if(lowerMsg.includes('cảm ơn') || lowerMsg.includes('thanks')) {
                return "Không có gì! Nếu bạn có thêm câu hỏi nào, tôi luôn sẵn sàng giúp đỡ 😊";
            } else if(lowerMsg.includes('giờ') || lowerMsg.includes('time')) {
                return `Bây giờ là ${new Date().toLocaleTimeString()}`;
            } else {
                return "Tôi là một AI và đang học hỏi mỗi ngày. Câu hỏi của bạn khá thú vị, nhưng hiện tại tôi chưa có đủ thông tin để trả lời chính xác. Bạn có thể hỏi về:<br>- <strong>Các khóa học AI</strong><br>- <strong>Công nghệ máy học</strong><br>- <strong>Hướng dẫn sử dụng hệ thống</strong>";
            }
        }

        // Danh sách các URL dự phòng cho API
        const apiEndpoints = [
            // URL hiện tại (có thể không hoạt động)
            'https://script.google.com/macros/s/AKfycbzhy4VezvPGrcQe48f0I0W4vFbQRFLQAebiDczuJ_Cbc8SUxs3xrpamifxGAelIcytS/exec',
            // URL từ file t.html
            'https://script.google.com/macros/s/AKfycbyBNO7Pb31AyBiuALXrwkRXyQGNrB61pKyVht5cP-nfWnEHz4P3lxUwG0MernH1kz0o/exec'
            // Thêm các URL dự phòng khác tại đây
        ];
        
        // Gọi API thông qua JSONP để vượt qua CORS
        async function makeApiCall(endpoint, requestData) {
            try {
                // Hiển thị thông báo đang kết nối
                updateStatusText('Đang kết nối đến máy chủ...');
                
                // Sử dụng URL từ danh sách endpoint
                const scriptUrl = apiEndpoints[0]; // Bắt đầu với URL đầu tiên
                
                // Tạo callback ID duy nhất
                const callbackId = 'callback_' + Date.now();
                
                // Tạo promise để đợi response
                return new Promise((resolve, reject) => {
                    // Tạo timeout - tăng lên 10 giây để có thêm thời gian kết nối
                    const timeoutId = setTimeout(() => {
                        // Cập nhật trạng thái khi timeout
                        updateStatusText('Không thể kết nối đến máy chủ. Đang sử dụng phản hồi nội bộ.');
                        
                        // Sử dụng fallback nếu timeout
                        const fallbackResponse = getLocalBotResponse(requestData.prompt);
                        // console.log("Timeout - sử dụng fallback response:", fallbackResponse);
                        
                        // Xóa callback
                        window[callbackId] = undefined;
                        
                        // Xóa script nếu còn tồn tại
                        const scriptElement = document.getElementById('jsonp_script');
                        if (scriptElement) {
                            document.head.removeChild(scriptElement);
                        }
                        
                        resolve({
                            choices: [{
                                message: {
                                    content: fallbackResponse
                                }
                            }]
                        });
                    }, 10000); // Tăng thời gian timeout từ 5000 lên 10000 (10 giây)
                    
                    // Tạo callback cho JSONP
                    window[callbackId] = function(data) {
                        clearTimeout(timeoutId);
                        
                        // Cập nhật trạng thái khi có phản hồi
                        updateStatusText('Kết nối thành công.');
                        setTimeout(() => updateStatusText(''), 3000); // Xóa thông báo sau 3 giây
                        
                        // Xóa script
                        const scriptElement = document.getElementById('jsonp_script');
                        if (scriptElement) {
                            document.head.removeChild(scriptElement);
                        }
                        
                        // Xóa callback để tránh memory leak
                        window[callbackId] = undefined;
                        
                        if (data && data.answer) {
                            resolve({
                                choices: [{
                                    message: {
                                        content: data.answer
                                    }
                                }]
                            });
                        } else if (data && data.message) {
                            console.warn("API trả về lỗi:", data.message);
                            updateStatusText('Máy chủ trả về lỗi: ' + data.message);
                            const fallbackResponse = getLocalBotResponse(requestData.prompt);
                            // console.log("Sử dụng fallback response:", fallbackResponse);
                            
                            resolve({
                                choices: [{
                                    message: {
                                        content: fallbackResponse
                                    }
                                }]
                            });
                        } else {
                            console.warn("API không trả về dữ liệu hợp lệ");
                            updateStatusText('Không nhận được phản hồi hợp lệ từ máy chủ.');
                            const fallbackResponse = getLocalBotResponse(requestData.prompt);
                            // console.log("Sử dụng fallback response:", fallbackResponse);
                            
                            resolve({
                                choices: [{
                                    message: {
                                        content: fallbackResponse
                                    }
                                }]
                            });
                        }
                    };
                    
                    // Tạo URL với tham số
                    const url = new URL(scriptUrl);
                    url.searchParams.append('question', requestData.prompt);
                    url.searchParams.append('callback', callbackId);
                    url.searchParams.append('timestamp', new Date().getTime());
                    
                    // Tạo script element để gọi JSONP
                    const script = document.createElement('script');
                    script.id = 'jsonp_script';
                    script.src = url.toString();
                    
                    // Thêm xử lý lỗi cho script 
                    script.onerror = function() {
                        console.error("Lỗi kết nối API, đang thử URL dự phòng");
                        
                        // Nếu còn URL dự phòng và đây không phải URL cuối cùng, thử URL tiếp theo
                        const currentIndex = apiEndpoints.indexOf(scriptUrl);
                        if (currentIndex >= 0 && currentIndex < apiEndpoints.length - 1) {
                            // Xóa script hiện tại
                            document.head.removeChild(script);
                            
                            // Thử với URL tiếp theo
                            // console.log("Đang thử với URL dự phòng:", apiEndpoints[currentIndex + 1]);
                            updateStatusText('Đang thử kết nối với máy chủ dự phòng...');
                            
                            // Tạo script mới với URL tiếp theo
                            const newScript = document.createElement('script');
                            newScript.id = 'jsonp_script';
                            const newUrl = new URL(apiEndpoints[currentIndex + 1]);
                            newUrl.searchParams.append('question', requestData.prompt);
                            newUrl.searchParams.append('callback', callbackId);
                            newUrl.searchParams.append('timestamp', new Date().getTime());
                            newScript.src = newUrl.toString();
                            document.head.appendChild(newScript);
                            
                            // Không trigger timeout lại, vẫn sử dụng timeout ban đầu
                        } else {
                            // Đã thử tất cả các URL, sử dụng fallback
                            clearTimeout(timeoutId); // Xóa timeout hiện tại
                            
                            updateStatusText('Không thể kết nối đến bất kỳ máy chủ nào. Đang sử dụng phản hồi nội bộ.');
                            
                            // Sử dụng fallback response
                            const fallbackResponse = getLocalBotResponse(requestData.prompt);
                            // console.log("Tất cả URL đều thất bại - sử dụng fallback response:", fallbackResponse);
                            
                            // Xử lý như timeout
                            window[callbackId] = undefined;
                            resolve({
                                choices: [{
                                    message: {
                                        content: fallbackResponse
                                    }
                                }]
                            });
                        }
                    };
                    
                    document.head.appendChild(script);
                });
            } catch (error) {
                console.error('Lỗi gọi API:', error);
                updateStatusText('Lỗi khi kết nối: ' + error.message);
                
                // Sử dụng fallback response khi API fails
                const fallbackResponse = getLocalBotResponse(requestData.prompt);
                // console.log("Sử dụng fallback response:", fallbackResponse);
                
                return {
                    choices: [{
                        message: {
                            content: fallbackResponse
                        }
                    }]
                };
            }
        }

        // Hàm xử lý việc gửi tin nhắn
        async function handleSendMessage() {
            try {
                const userInput = messageInput.value.trim();
                
                if (!userInput) {
                    return; // Không làm gì nếu tin nhắn trống
                }

                // Hiển thị thông báo người dùng
                addToChat('user', userInput);
                
                // Xóa input sau khi gửi
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // Disable nút gửi và hiển thị loading
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                // Gọi API để lấy câu trả lời
                const response = await makeApiCall('chat', { prompt: userInput });
                
                // Hiển thị câu trả lời từ bot
                if (response && response.choices && response.choices[0]) {
                    addToChat('bot', response.choices[0].message.content);
                } else {
                    addToChat('bot', 'Xin lỗi, tôi không thể xử lý yêu cầu của bạn lúc này.');
                }
                
            } catch (error) {
                console.error("Lỗi khi gửi tin nhắn:", error);
                addToChat('bot', 'Đã xảy ra lỗi khi xử lý tin nhắn của bạn.');
            } finally {
                // Restore nút gửi
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                sendBtn.disabled = messageInput.value.trim() === '';
            }
        }

        // Đảm bảo các DOM elements được khởi tạo đúng
        document.addEventListener('DOMContentLoaded', function() {
            // Kiểm tra xem đã lấy được các DOM elements chưa
            if (!chatMessages) chatMessages = document.getElementById('chatMessages');
            if (!messageInput) messageInput = document.getElementById('messageInput');
            if (!sendBtn) sendBtn = document.getElementById('sendBtn');
            
            // console.log("DOM Elements:", {chatMessages, messageInput, sendBtn});
            
            if (messageInput && sendBtn) {
                // Đảm bảo nút được enable khi có text
                messageInput.addEventListener('input', function() {
                    sendBtn.disabled = this.value.trim() === '';
                    
                    // Auto-resize textarea
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
                
                // Thêm sự kiện click cho nút gửi
                sendBtn.addEventListener('click', function() {
                    if (messageInput.value.trim() !== '') {
                        if (typeof handleSendMessage === 'function') {
                            handleSendMessage();
                        } else {
                            console.error("handleSendMessage không được định nghĩa");
                            alert("Lỗi: Chức năng gửi tin nhắn chưa được cài đặt");
                        }
                    }
                });
                
                // Thêm sự kiện Enter để gửi tin nhắn
                messageInput.addEventListener('keydown', function(e) {
                    if(e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if(messageInput.value.trim() !== '') {
                            if (typeof handleSendMessage === 'function') {
                                handleSendMessage();
                            }
                        }
                    }
                });
                
                // Enable nút gửi nếu có text
                if (messageInput.value.trim() !== '') {
                    sendBtn.disabled = false;
                }
            } else {
                console.error("Không tìm thấy các DOM elements cần thiết");
            }
        });

        saveApiKeyBtn.addEventListener('click', function() {
            const apiKey = apiKeyInput.value;
            const apiKeyType = document.querySelector('input[name="apiKeyType"]:checked').value;
            
            if (saveApiKey(apiKey, apiKeyType)) {
                apiKeySet = true;
                apiStatusIndicator.classList.remove('status-inactive');
                apiStatusIndicator.classList.add('status-active');
                toggleApiKeyModal(false);
                
                // Lưu URL Apps Script nếu đã nhập
                const customUrl = document.getElementById('appsScriptUrlInput').value.trim();
                if (customUrl && customUrl.startsWith('https://script.google.com/macros/s/')) {
                    saveCustomScriptUrl(customUrl);
                }
            }
        });

        // Lưu URL Google Apps Script tùy chỉnh
        function saveCustomScriptUrl(url) {
            try {
                if (!url) return false;
                
                // Kiểm tra tính hợp lệ của URL
                if (!url.startsWith('https://script.google.com/macros/s/')) {
                    alert('URL Google Apps Script không hợp lệ. URL phải bắt đầu bằng "https://script.google.com/macros/s/"');
                    return false;
                }
                
                // Lưu URL vào localStorage
                localStorage.setItem('custom_script_url', url);
                // console.log('Đã lưu URL Apps Script tùy chỉnh:', url);
                
                // Cập nhật danh sách URL
                loadCustomScriptUrl();
                
                return true;
            } catch (error) {
                console.error('Lỗi khi lưu URL tùy chỉnh:', error);
                return false;
            }
        }
        
        // Tải URL tùy chỉnh và thêm vào danh sách endpoints
        function loadCustomScriptUrl() {
            try {
                const customUrl = localStorage.getItem('custom_script_url');
                if (customUrl) {
                    // console.log('Đã tìm thấy URL tùy chỉnh:', customUrl);
                    
                    // Đặt URL tùy chỉnh lên đầu danh sách để ưu tiên sử dụng
                    if (!apiEndpoints.includes(customUrl)) {
                        apiEndpoints.unshift(customUrl);
                        // console.log('Danh sách URL đã cập nhật:', apiEndpoints);
                    }
                    
                    // Hiển thị URL tùy chỉnh trong form
                    const urlInput = document.getElementById('appsScriptUrlInput');
                    if (urlInput) {
                        urlInput.value = customUrl;
                    }
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Lỗi khi tải URL tùy chỉnh:', error);
                return false;
            }
        }
        
        // Tải URL tùy chỉnh khi trang web khởi động
        loadCustomScriptUrl();
    </script>
</body>
</html>